stages:
  - validate
  - test
  - deploy
  - verify

before_script:
  - git submodule sync
    
  # Override submodule URLs with CI_JOB_TOKEN (works in GitLab CE)
  - git submodule set-url frontend "https://gitlab-ci-token:${CI_JOB_TOKEN}@git.fhict.nl/I555567/semester-3-individual-project-frontend.git"
  - git submodule set-url backend  "https://gitlab-ci-token:${CI_JOB_TOKEN}@git.fhict.nl/I555567/semester-3-individual-project-backend.git"

  # Pull submodules
  - git submodule update --init --recursive


validate_compose:
  stage: validate
  script:
    - git submodule sync
    - git submodule update --init --recursive
    - echo "Submodules updated"
    - echo "Validating docker-compose.yml..."
    - docker compose config
  only:
    - main

test_infra:
  stage: test
  needs:
    - validate_compose
  script:
    - echo "Running basic infra tests..."
    - powershell -Command "if (-Not (Test-Path docker-compose.yml)) { Write-Error 'Missing docker-compose.yml'; exit 1 }"
    - echo "OK: compose file exists"
    - echo "OK: validation stage passed"
  only:
    - main

deploy_stack:
  stage: deploy
  needs:
    - test_infra
  script:
    - echo "Pulling latest images..."
    - docker compose pull
    - echo "Starting containers..."
    - docker compose up -d --remove-orphans
  only:
    - main

verify_stack:
  stage: verify
  needs:
    - deploy_stack
  script:
    - echo "Checking running containers..."
    - docker compose ps
    - echo "Fetching logs..."
    - docker compose logs --tail=50
  only:
    - main
