stages:
  - validate
  - test
  - deploy
  - verify

validate_compose:
  stage: validate
  script:
    - "echo Validating docker-compose.yml..."
    - "docker compose config"
  only:
    - main

test_infra:
  stage: test
  needs:
    - validate_compose
  script:
    - "echo Running basic infra tests..."
    - "test -f docker-compose.yml || (echo Missing docker-compose.yml && exit 1)"
    - "echo OK: compose file exists"
    - "echo OK: validation stage passed"
  only:
    - main

deploy_stack:
  stage: deploy
  needs:
    - test_infra
  script:
    - "echo Pulling latest images..."
    - "docker compose pull"
    - "echo Starting containers..."
    - "docker compose up -d --remove-orphans"
  only:
    - main

verify_stack:
  stage: verify
  needs:
    - deploy_stack
  script:
    - "echo Checking running containers..."
    - "docker compose ps"
    - "echo Fetching logs..."
    - "docker compose logs --tail=50"
  only:
    - main
