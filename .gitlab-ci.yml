variables:
  GIT_SUBMODULE_STRATEGY: recursive

stages:
  - validate
  - test
  - deploy
  - verify

validate_compose:
  stage: validate
  script:
    - Write-Host "Validating docker-compose.yml..."
    - docker compose config
  only:
    - main

test_infra:
  stage: test
  needs:
    - validate_compose
  script:
    - Write-Host "Running basic infra tests..."
    - |
      if (-Not (Test-Path "docker-compose.yml")) {
          Write-Host "❌ Missing docker-compose.yml"
          exit 1
      } else {
          Write-Host "✅ docker-compose.yml exists"
      }
    - Write-Host "✅ Validation stage passed"
  only:
    - main

deploy_stack:
  stage: deploy
  needs:
    - test_infra
  script:
    - Write-Host "Pulling latest images..."
    - docker compose pull
    - Write-Host "Starting containers..."
    - docker compose up -d --remove-orphans
  only:
    - main

verify_stack:
  stage: verify
  needs:
    - deploy_stack
  script:
    - Write-Host "Checking running containers..."
    - docker compose ps
    - Write-Host "Fetching logs..."
    - docker compose logs --tail=50
  only:
    - main
