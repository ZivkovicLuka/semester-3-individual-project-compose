stages:
  - validate
  - test
  - deploy
  - verify

# -----------------------------
# VALIDATE CONFIG
# -----------------------------
validate_compose:
  stage: validate
  script:
    - echo "Validating docker-compose.yml..."
    - docker compose config
  only:
    - main

# -----------------------------
# BASIC TESTS
# -----------------------------
test_infra:
  stage: test
  needs: ["validate_compose"]
  script:
    - echo "Running basic infra tests..."
    - test -f docker-compose.yml
    - echo "OK: docker-compose.yml exists"
    - echo "OK: Validation stage passed"
  only:
    - main

# -----------------------------
# DEPLOY SERVICES
# -----------------------------
deploy_stack:
  stage: deploy
  needs: ["test_infra"]
  script:
    - echo "Pulling latest images..."
    - docker compose pull
    - echo "Starting containers..."
    - docker compose up -d --remove-orphans
  only:
    - main

# -----------------------------
# VERIFY DEPLOYMENT
# -----------------------------
verify_stack:
  stage: verify
  needs: ["deploy_stack"]
  script:
    - echo "Checking service status..."
    - docker compose ps
    - echo "Checking logs..."
    - docker compose logs --tail=50
    - echo "Verification complete."
  only:
    - main
